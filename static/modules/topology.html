<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <div class="section-header" style="margin-bottom:0;">
        <h3>Network Topology</h3>
    </div>
    <div style="display:flex; gap:15px; align-items:center;">
        <span style="font-family:'JetBrains Mono';font-size:10px;color:#666;">
            <span id="topo-online" style="color:var(--success);">0</span> online /
            <span id="topo-total" style="color:#888;">0</span> total
        </span>
        <button class="btn-primary" onclick="topoFit()" style="padding:4px 12px;font-size:10px;">
            <i class="fas fa-compress-arrows-alt"></i> FIT
        </button>
    </div>
</div>

<div id="topology-container" style="width:100%; height:calc(100vh - 220px); border:1px solid var(--border); border-radius:4px; background:var(--bg); position:relative;">
    <div id="topo-loading" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'JetBrains Mono';font-size:11px;color:#555;">
        LOADING_TOPOLOGY_ENGINE...
    </div>
</div>

<!-- Legend -->
<div style="display:flex; gap:20px; margin-top:10px; font-family:'JetBrains Mono'; font-size:10px; color:#666;">
    <div style="display:flex; align-items:center; gap:5px;">
        <div style="width:10px;height:10px;border-radius:50%;background:#00ffb3;"></div> ONLINE
    </div>
    <div style="display:flex; align-items:center; gap:5px;">
        <div style="width:10px;height:10px;border-radius:50%;background:#ff3b30;"></div> OFFLINE
    </div>
    <div style="display:flex; align-items:center; gap:5px;">
        <div style="width:12px;height:12px;background:#ff9d00;transform:rotate(45deg);"></div> C2 SERVER
    </div>
</div>

<script>
(function() {
    let network = null;
    let topoInterval = null;

    window.topoFit = function() {
        if (network) network.fit({ animation: { duration: 500, easingFunction: 'easeInOutQuad' } });
    };

    function countryFlag(code) {
        if (!code || code.length !== 2) return '';
        return String.fromCodePoint(
            ...Array.from(code.toUpperCase()).map(c => 0x1F1E6 + c.charCodeAt(0) - 65)
        );
    }

    function loadVisNetwork() {
        if (typeof vis !== 'undefined' && vis.Network) {
            initTopology();
            return;
        }
        const s = document.createElement('script');
        s.src = 'https://unpkg.com/vis-network@9.1.9/standalone/umd/vis-network.min.js';
        s.onload = initTopology;
        s.onerror = function() {
            const el = document.getElementById('topo-loading');
            if (el) el.textContent = 'FAILED_TO_LOAD_VIS_NETWORK_CDN';
        };
        document.head.appendChild(s);
    }

    function initTopology() {
        const el = document.getElementById('topo-loading');
        if (el) el.style.display = 'none';
        fetchAndRender();
        topoInterval = setInterval(fetchAndRender, 10000);
    }

    async function fetchAndRender() {
        try {
            const resp = await fetch('/api/clients', {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (resp.status === 401) return;
            const result = await resp.json();
            if (result.status === 'success') renderTopology(result.data || []);
        } catch(e) { console.error('Topology fetch error:', e); }
    }

    function renderTopology(clients) {
        const container = document.getElementById('topology-container');
        if (!container || typeof vis === 'undefined') return;

        const onlineEl = document.getElementById('topo-online');
        const totalEl = document.getElementById('topo-total');
        if (onlineEl) onlineEl.textContent = clients.filter(c => c.status === 'online').length;
        if (totalEl) totalEl.textContent = clients.length;

        const nodes = [];
        const edges = [];

        // C2 Server node
        nodes.push({
            id: '__c2__',
            label: 'PRTSTRIKE\nC2 SERVER',
            shape: 'diamond',
            size: 35,
            color: { background: 'rgba(255,157,0,0.2)', border: '#ff9d00', highlight: { background: '#ff9d00', border: '#fff' } },
            font: { color: '#ff9d00', size: 13, face: 'JetBrains Mono', bold: true },
            borderWidth: 3,
            shadow: { enabled: true, color: 'rgba(255,157,0,0.3)', size: 15 }
        });

        clients.forEach(client => {
            const online = client.status === 'online';
            const isWin = (client.os || '').toLowerCase().includes('win');
            const statusColor = online ? '#00ffb3' : '#ff3b30';
            const bgColor = online ? 'rgba(0,255,179,0.08)' : 'rgba(255,59,48,0.08)';

            const flag = countryFlag(client.country_code);
            const lines = [
                (client.hostname || client.name || 'UNKNOWN'),
                client.ip + (flag ? '  ' + flag : ''),
                (client.username || '-') + (client.is_admin ? ' \u2605' : ''),
            ];

            nodes.push({
                id: client.id,
                label: lines.join('\n'),
                shape: 'box',
                color: { background: bgColor, border: statusColor, highlight: { background: statusColor, border: '#fff' } },
                borderWidth: online ? 2 : 1,
                font: { color: '#c0c0c0', size: 10, face: 'JetBrains Mono', multi: false, align: 'center' },
                margin: { top: 8, bottom: 8, left: 12, right: 12 },
                shadow: online ? { enabled: true, color: 'rgba(0,255,179,0.15)', size: 10 } : false
            });

            edges.push({
                from: '__c2__',
                to: client.id,
                color: { color: online ? 'rgba(0,255,179,0.25)' : 'rgba(255,59,48,0.15)', highlight: statusColor },
                width: online ? 2 : 1,
                dashes: !online,
                smooth: { type: 'continuous', roundness: 0.15 },
                arrows: { to: { enabled: true, scaleFactor: 0.4 } }
            });
        });

        const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };

        const options = {
            physics: {
                solver: 'forceAtlas2Based',
                forceAtlas2Based: {
                    gravitationalConstant: -80,
                    centralGravity: 0.008,
                    springLength: 180,
                    springConstant: 0.06,
                    damping: 0.4
                },
                stabilization: { iterations: 200, fit: true }
            },
            interaction: {
                hover: true,
                tooltipDelay: 200,
                zoomView: true,
                dragView: true,
                dragNodes: true
            },
            layout: { randomSeed: 42 }
        };

        if (network) {
            network.setData(data);
        } else {
            network = new vis.Network(container, data, options);
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    if (nodeId !== '__c2__') {
                        const client = clients.find(c => c.id === nodeId);
                        if (client && typeof selectBeacon === 'function') {
                            selectBeacon(client.id, client.ip);
                        }
                    }
                }
            });
            network.on('stabilizationIterationsDone', function() {
                network.fit({ animation: { duration: 500 } });
            });
        }
    }

    loadVisNetwork();

    // Cleanup on module unload
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(m) {
            if (m.removedNodes.length > 0) {
                const container = document.getElementById('topology-container');
                if (!container) {
                    if (topoInterval) clearInterval(topoInterval);
                    if (network) { network.destroy(); network = null; }
                    observer.disconnect();
                }
            }
        });
    });
    const mc = document.getElementById('module-container');
    if (mc) observer.observe(mc, { childList: true });
})();
</script>
